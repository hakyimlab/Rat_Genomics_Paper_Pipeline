---
title: "Generate Sparsity Figures"
author: "Natasha Santhanam"
date: "3/9/2022"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)
library(ggplot2)
library(RSQLite)
dir <- "/Users/natashasanthanam/Github/rat-genomic-analysis/data/"
source("./Rat_Genomics_Paper_Pipeline/analysis/02.Prediction_Model_Pipeline.Rmd")
```

## Generate R2 predictions for all elastic net parameters between 0 and 1

We run the same Prediction Model Pipeline only for Ac tissue. However this time, I didn't break it down into chromosome. This takes longer but means you have less files, a file for each alpha parameter. 

```{bash}
for i in {0..1..0.1}
do
Rscript --vanilla ./Rat_Genomics_Paper_Pipeline/analysis/prediction_pipeline_all_alphas_EN.R $i 
done
```


Now we have predictability for all parameters of alpha. We can now iterate through all alphas and create the long data format. We also only select for genes that have an average cor > 0.3 and subsample 20 genes. 
```{r create long format for genes, eval=FALSE}
ldf <- list() # creates a list
listtsv <- dir(path = dir, pattern = "working_TW_Ac_exp_10-foldCV_elasticNet_alpha", full.names = TRUE) # creates the list of all the tsv files in the directory
tempo <- read_tsv(listtsv[1], col_names = TRUE) 
tempo$R2 = tempo$R2*sign(tempo$cor)
tempo <- tempo %>% select(c(gene, R2))
colnames(tempo)[2] = "0.1"

for (k in 2:length(listtsv)){
 ldf[[k]] <- read_tsv(listtsv[k], col_names = TRUE)
 alpha <- substr(listtsv[k], 107, str_length(listtsv[k]) - 13)
 fila <- as.data.frame(ldf[[k]]) 
 fila$R2 = fila$R2*sign(fila$cor)
 fila <- fila %>% select(c(gene, R2)) 
 colnames(fila)[2] = alpha
 tempo <- inner_join(tempo, fila, by = "gene")
 
}
```

Plot results of r for all parameers of alpha
```{r plot all resuls, eval=FALSE}
tempo <- read_tsv(dir %&% "rat_elasticNet_cor.txt", col_names = TRUE)
tempo <- read_tsv("/Users/natashasanthanam/Downloads/rat_Ac_elasticNet_R2.txt", col_names = TRUE)

data_long <- tempo  %>%   pivot_longer(!gene, names_to = "value", values_to = "count")
   
p1 <-  ggplot(data_long, aes(x = as.numeric(value), y = count)) + geom_smooth(show_guide = FALSE, se=T, size = .5, col = "dodgerblue2")  +  xlab(expression(paste("Elastic net mixing parameter (",alpha, ")"))) + ylab(expression(paste("10-fold cross-validated R2")))

p2 = ggplot(tempo, aes(x = `0`, y = `0.5`)) + geom_hex(bins = 50)   +
      geom_abline(slope = 1, intercept = 0, color = "darkgrey", size = 0.8) +
      ylab("cor for mixing paramter = 0.5" ) +
      xlab("cor for mixing paramter = 0") + theme_bw(base_size = 16)

p1
```

